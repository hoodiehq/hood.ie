/*!
 * jquery-sheetrock v0.2.3
 * Quickly connect to, query, and lazy-load data from Google Spreadsheets.
 * http://chriszarate.github.io/sheetrock/
 * License: MIT
 */
!function(a){"use strict";"function"==typeof define&&define.amd?define("jquery.sheetrock",["jquery"],a):"object"==typeof module&&module.exports?module.exports=a:a(window.jQuery)}(function(a){"use strict";a.fn.sheetrock=function(a,b){return a.target=this,a=s(a),a&&(x(b)&&null!==b?g(a,b):f(a)),this};var b={"new":{endpoint:"https://docs.google.com/spreadsheets/d/%key%/gviz/tq",keyFormat:new RegExp("spreadsheets/d/([^/#]+)","i")},legacy:{endpoint:"https://spreadsheets.google.com/tq?key=%key%",keyFormat:new RegExp("key=([^&#]+)","i")}},c={loaded:{},failed:{},offset:{}},d={},e=0,f=function(b){a.fn.sheetrock.promise=a.fn.sheetrock.promise.pipe(function(){return h(b)}).pipe(function(){return i(b)})},g=function(a,b){k(a),n.call(a,b),l.call(a)},h=function(b){var c={sql:"select * limit 1",dataHandler:q,userCallback:a.noop,target:!1};return-1===b.sql.indexOf("%")||r(b)?a.Deferred().resolve():(y("Prefetching column labels."),i(a.extend({},b,c)))},i=function(b){k(b),b.callback="sheetrock_callback_"+e,e+=1;var c={data:j(b),context:b,url:b.server,dataType:"jsonp",cache:!0,jsonp:!1,jsonpCallback:b.callback};return y(c,b.debug),a.ajax(c).promise().done(n).fail(t).always(l)},j=function(a){var b={gid:a.gid,tqx:"responseHandler:"+a.callback};return a.sql&&(b.tq=E(a.sql,r(a))),b},k=function(b){b.loading.show(),a.fn.sheetrock.working=!0},l=function(){this.loading.hide(),a.fn.sheetrock.working=!1,this.userCallback(this)},m=function(b,c){w(b,c)&&a.each(b[c],function(a,b){w(b,"detailed_message")?y(b.detailed_message):w(b,"message")&&y(b.message)})},n=function(a){if(m(a,"warnings"),m(a,"errors"),y(a,this.debug),w(a,"status","table")&&w(a.table,"cols","rows")){var b=o.call(this,a);this.dataHandler.call(b,a)}else t.call(this,a)},o=function(b){var d=this;return d.parsed={},d.parsed.last=d.chunkSize?Math.min(b.table.rows.length,d.chunkSize):b.table.rows.length,c.loaded[d.requestID]=!d.chunkSize||d.parsed.last<d.chunkSize,d.parsed.header=a.map(b.table.cols,C).length?1:0,d.parsed.labels=d.labels&&d.labels.length===b.table.cols.length?d.labels:a.map(b.table.cols,D),d},p=function(b){var c=this,d=c.target;a.extend(c,{thead:c.rowGroups?a("<thead/>").appendTo(d):d,tbody:c.rowGroups?a("<tbody/>").appendTo(d):d}),c.offset||c.headersOff||(c.parsed.header||!c.headers)&&c.thead.append(c.rowHandler({num:0,cells:G(c.parsed.labels)})),a.each(b.table.rows,function(b,d){if(w(d,"c")&&b<c.parsed.last){var e=v(c.offset+b+1+c.parsed.header-c.headers),f={num:e,cells:{}};(e||!c.headersOff)&&(a.each(d.c,function(a,b){var d=c.formatting?H(b):!1,e=b&&w(b,"v")&&b.v?b.v:"";e instanceof Array&&(e=w(b,"f")?b.f:e.join("")),e=c.cellHandler(e),f.cells[c.parsed.labels[a]]=d?J(e,"span",d):e}),f.num?c.tbody.append(c.rowHandler(f)):c.thead.append(c.rowHandler(f)))}})},q=function(b){var c={};a.each(b.table.cols,function(a,b){c[b.id]=D(b)}),d[this.key+"_"+this.gid]=c},r=function(b){return a.isEmptyObject(b.columns)?d[b.key+"_"+b.gid]||!1:b.columns},s=function(b){return b=a.extend({},a.fn.sheetrock.options,b),b.type=z(b.url),b.key=A(b.url,b.type),b.gid=B(b.url),b.server=b.server.length?b.server:b.type.endpoint,b.server=b.server.replace("%key%",b.key),b.key&&b.gid&&(b.requestID=b.key+"_"+b.gid+"_"+b.sql),b.chunkSize=b.target.length?v(b.chunkSize):0,b.headers=v(b.headers),b.loading=F(b.loading),b.resetStatus&&b.requestID&&(c.loaded[b.requestID]=!1,c.failed[b.requestID]=!1,c.offset[b.requestID]=0,y("Resetting request status.")),b.offset=c.offset[b.requestID]||0,b.chunkSize&&b.target&&b.requestID&&(b.sql+=" limit "+(b.chunkSize+1),b.sql+=" offset "+b.offset,c.offset[b.requestID]=b.offset+b.chunkSize),b.target.length||b.dataHandler!==p?b.url?b.key?b.gid?c.failed[b.requestID]?t.call(b,null,"A previous request for this resource failed."):c.loaded[b.requestID]?y("No more rows to load!"):(y(b,b.debug),b):t.call(b,null,"Could not find a gid in the provided URL."):t.call(b,null,"Could not find a key in the provided URL."):t.call(b,null,"No spreadsheet URL provided."):t.call(b,null,"No element targeted or data handler provided.")},t=function(a,b){return b=b||"Request failed.",this&&this.requestID&&(c.failed[this.requestID]=!0),y(b),this.errorHandler.call(this,a,b),!1},u=function(a){return a.toString().replace(/^ +/,"").replace(/ +$/,"")},v=function(a){return Math.max(0,parseInt(a,10)||0)},w=function(a){for(var b=1;b<arguments.length;b+=1)if(!x(a[arguments[b]]))return!1;return!0},x=function(){for(var a=0;a<arguments.length;a+=1)if("undefined"==typeof arguments[a])return!1;return!0},y=function(a,b){return b=x(b,console)?b:!0,b&&console.log&&console.log(a),!1},z=function(c){var d;return a.each(b,function(a,b){return b.keyFormat.test(c)?(d=b,!1):void 0}),d||b.new},A=function(a,b){return b.keyFormat.test(a)?a.match(b.keyFormat)[1]:!1},B=function(a){var b=new RegExp("gid=([^/&#]+)","i");return b.test(a)?a.match(b)[1]:!1},C=function(a){return w(a,"label")?a.label.replace(/\s/g,""):null},D=function(a){return C(a)||a.id},E=function(b,c){return a.each(c,function(a,c){b=b.replace(new RegExp("%"+c+"%","g"),a)}),b},F=function(b){return!b||b instanceof a?b:a(b)},G=function(b){var c={};return a.each(b,function(a,b){c[b]=b}),c},H=function(a){return a&&w(a,"p")&&w(a.p,"style")?a.p.style:!1},I=function(a){var b,c="",d=a.num?"td":"th";for(b in a.cells)w(a.cells,b)&&(c+=J(a.cells[b],d,""));return J(c,"tr","")},J=function(a,b,c){var d=c?' style="'+c+'"':"";return"<"+b+d+">"+a+"</"+b+">"};a.fn.sheetrock.options={url:"",sql:"",server:"",chunkSize:0,columns:{},labels:[],rowHandler:I,cellHandler:u,dataHandler:p,errorHandler:a.noop,userCallback:a.noop,loading:a(),headers:0,headersOff:!1,rowGroups:!0,formatting:!1,resetStatus:!1,debug:!1},a.fn.sheetrock.working=!1,a.fn.sheetrock.promise=a.Deferred().resolve(),a.fn.sheetrock.version="0.2.3"});
